<!DOCTYPE html>
<html lang="en">
    <%- include('../head.ejs') %>

    <body>
        <%- include('../nav.ejs') %>
        <div class="ms-4 mt-3">
            <h3>
                <%= chatroom.memberName[0] == user.username ?
                chatroom.memberName[1] : chatroom.memberName[0] %>와의 채팅
            </h3>
        </div>
        <div class="chatting">
            <div class="mt-3">
                <% for (let i=0; i < chat.length; i++) { %> <% if (
                chat[i].author != user._id ) { %>
                <div
                    class="card my-2 mx-4 px-3 py-3 yourchat"
                    style="min-width: 50%; max-width: 70%"
                >
                    <h5 class="card-title">
                        <%= chatroom.memberName[0] == user.username ?
                        chatroom.memberName[1] : chatroom.memberName[0] %>
                    </h5>
                    <p class="card-text"><%= chat[i].msg %></p>
                </div>
                <% } else { %>
                <div
                    class="card my-2 mx-4 px-3 py-3 bg-secondary-subtle mychat"
                    style="min-width: 50%; max-width: 70%; float: right"
                >
                    <h5 class="card-title"><%= user.username %></h5>
                    <p class="card-text"><%= chat[i].msg %></p>
                </div>
                <% } %> <% } %>
            </div>
            <!-- 채팅창 아래 부분이 가려지는 문제 해결을 위해 빈 div 추가 -->
            <div class="mt-3 empty" style="clear: both; height: 50px"></div>

            <div class="fixed-bottom bg-white" style="width: 100%">
                <div class="ms-3" style="text-align: center; display: block">
                    <input
                        class="form-control chat-input"
                        style="width: 80%; display: inline-block"
                    />
                    <button
                        class="btn btn-secondary mx-1 my-2 chat-add"
                        style="display: inline-block"
                    >
                        작성
                    </button>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.socket.io/4.7.4/socket.io.min.js"
            integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4"
            crossorigin="anonymous"
        ></script>

        <script>
            window.onload = function () {
                window.scrollTo(0, document.body.scrollHeight);
            };

            const socket = io();
            socket.emit('room-join', '<%= chatroom._id %>');

            document
                .querySelector('.chat-add')
                .addEventListener('click', async function (e) {
                    const msg = document.querySelector('.chat-input').value;
                    await socket.emit('msg', {
                        msg: msg,
                        room: '<%= chatroom._id %>',
                        author: '<%= user._id %>',
                    });

                    const mychat = document.createElement('div');
                    mychat.classList.add(
                        'card',
                        'my-2',
                        'mx-4',
                        'px-3',
                        'py-3',
                        'bg-secondary-subtle',
                        'yourchat',
                    );
                    mychat.style.minWidth = '50%';
                    mychat.style.maxWidth = '70%';
                    mychat.style.float = 'right';

                    const username = document.createElement('h5');
                    username.classList.add('card-title');
                    username.textContent = '<%= user.username %>';

                    const chatmsg = document.createElement('p');
                    chatmsg.classList.add('card-text');
                    chatmsg.textContent = msg;

                    mychat.appendChild(username);
                    mychat.appendChild(chatmsg);

                    const emptydiv = document.querySelector('.empty');
                    emptydiv.parentNode.insertBefore(mychat, emptydiv);

                    document.querySelector('.chat-input').value = '';

                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth',
                    });
                });

            socket.on('msg', (data) => {
                console.log('서버에서 온 data :', data);
                if (data.author != '<%= user._id %>') {
                    const yourchat = document.createElement('div');
                    yourchat.classList.add(
                        'card',
                        'my-2',
                        'mx-4',
                        'px-3',
                        'py-3',
                        'mychat',
                    );
                    yourchat.style.minWidth = '50%';
                    yourchat.style.maxWidth = '70%';

                    const username = document.createElement('h5');
                    username.classList.add('card-title');
                    username.textContent =
                        '<%= chatroom.memberName[0] == user.username ? chatroom.memberName[1] : chatroom.memberName[0] %>';

                    const chatmsg = document.createElement('p');
                    chatmsg.classList.add('card-text');
                    chatmsg.textContent = data.msg;

                    yourchat.appendChild(username);
                    yourchat.appendChild(chatmsg);

                    const emptydiv = document.querySelector('.empty');
                    emptydiv.parentNode.insertBefore(yourchat, emptydiv);

                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth',
                    });
                }
            });
        </script>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"
        ></script>
    </body>
</html>
